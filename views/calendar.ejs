<%- include('layouts/main', { pageTitle }) %>
<main class="calendar-view" data-equipment-id="<%= equipment.id %>"
      data-start-hour="<%= equipment.dailyStartHour %>"
      data-end-hour="<%= equipment.dailyEndHour %>"
      data-min-duration="<%= equipment.minDurationMinutes %>"
      data-max-duration="<%= equipment.maxDurationMinutes %>">
  <section class="equipment-hero">
    <div class="equipment-hero__info">
      <p class="eyebrow">Planowanie sesji</p>
      <h1><%= equipment.name %></h1>
      <p class="muted"><%= equipment.location %></p>
      <ul class="equipment-hero__meta">
        <li>Godziny pracy: <strong><%= equipment.dailyStartHour %>:00 - <%= equipment.dailyEndHour %>:00</strong></li>
        <li>Minimalny czas: <strong><%= equipment.minDurationMinutes %> min</strong></li>
        <li>Maksymalny czas: <strong><%= equipment.maxDurationMinutes %> min</strong></li>
      </ul>
    </div>
    <div class="equipment-hero__actions">
      <p class="muted">Kliknij na wolne miejsce w kalendarzu, aby utworzyć rezerwację.</p>
    </div>
  </section>

  <section class="calendar-nav">
    <a class="btn btn--ghost" href="/equipment/<%= equipment.id %>/calendar?date=<%= prevWeekDate %>">Poprzedni tydzień</a>
    <div>
      <h2>Tydzień <%= new Date(selectedDate).toLocaleDateString('pl-PL') %></h2>
      <p class="muted"><%= weekView.weekStart.toLocaleDateString('pl-PL') %> - <%= weekView.weekEnd.toLocaleDateString('pl-PL') %></p>
    </div>
    <a class="btn btn--ghost" href="/equipment/<%= equipment.id %>/calendar?date=<%= nextWeekDate %>">Następny tydzień</a>
  </section>

  <section class="calendar-timeline">
    <div class="calendar-timeline__hours">
      <% for (let h = equipment.dailyStartHour; h <= equipment.dailyEndHour; h++) { %>
        <div class="calendar-timeline__hour"><%= String(h).padStart(2, '0') %>:00</div>
      <% } %>
    </div>
    <div class="calendar-timeline__days">
      <% weekView.days.forEach((day) => { 
        const dateStr = day.date.toISOString().slice(0, 10);
        const eventsJson = JSON.stringify(day.events);
      %>
        <div class="calendar-day" data-date="<%= dateStr %>" data-events="<%= eventsJson.replace(/"/g, '&quot;') %>">
          <header class="calendar-day__header">
            <p class="calendar-day__name"><%= day.dayName %></p>
            <p class="calendar-day__date"><%= day.date.toLocaleDateString('pl-PL') %></p>
          </header>
          <div class="calendar-day__timeline">
            <% for (let h = equipment.dailyStartHour; h < equipment.dailyEndHour; h++) { %>
              <div class="calendar-day__hour-line"></div>
            <% } %>
            <% day.events.forEach((event) => { 
              const startMinutes = parseInt(event.startTime.split(':')[0]) * 60 + parseInt(event.startTime.split(':')[1]);
              const endMinutes = parseInt(event.endTime.split(':')[0]) * 60 + parseInt(event.endTime.split(':')[1]);
              const dayStartMinutes = equipment.dailyStartHour * 60;
              const dayEndMinutes = equipment.dailyEndHour * 60;
              const totalMinutes = dayEndMinutes - dayStartMinutes;
              const topPercent = ((startMinutes - dayStartMinutes) / totalMinutes) * 100;
              const heightPercent = ((endMinutes - startMinutes) / totalMinutes) * 100;
            %>
              <div class="calendar-event calendar-event--<%= event.type %> <%= event.isOwn ? 'calendar-event--own' : '' %> <%= event.isCompleted ? 'calendar-event--completed' : '' %>"
                   style="top: <%= topPercent %>%; height: <%= heightPercent %>%;"
                   data-event-id="<%= event.id %>"
                   data-start="<%= event.startTime %>"
                   data-end="<%= event.endTime %>">
                <span class="calendar-event__time"><%= event.startTime %> - <%= event.endTime %></span>
                <% if (event.isOwn) { %>
                  <small>Twoja rezerwacja</small>
                <% } else if (event.type === 'blocked') { %>
                  <small><%= event.reason || 'Zablokowane' %></small>
                <% } else { %>
                  <small>Zajęte</small>
                <% } %>
              </div>
            <% }) %>
          </div>
        </div>
      <% }) %>
    </div>
  </section>

  <section class="calendar-tips">
    <p>Kliknij wolne miejsce na kalendarzu i wybierz czas trwania rezerwacji. Twoje rezerwacje są oznaczone kolorem.</p>
  </section>

  <form id="booking-form" method="post" action="/bookings">
    <input type="hidden" name="equipmentId" value="<%= equipment.id %>" />
    <input type="hidden" name="bookingDate" />
    <input type="hidden" name="startTime" />
    <input type="hidden" name="duration" />
  </form>
</main>
<%- include('partials/footer') %>
